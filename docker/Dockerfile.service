FROM python:3.12.3-slim

# Set the working directory
WORKDIR /opt/render/project

# Copy requirements and install dependencies
COPY requirements.txt pyproject.toml uv.lock ./
RUN pip install --no-cache-dir -r requirements.txt

# Copy the src directory maintaining structure
COPY src ./src

# Set environment variables
ENV PYTHONPATH=/opt/render/project
ENV PORT=80

# Debug: Print directory structure
RUN echo "Current directory:" && pwd && \
    echo "\nContents of current directory:" && ls -la && \
    echo "\nContents of src directory:" && ls -la src && \
    echo "\nContents of src/service directory:" && ls -la src/service

EXPOSE 80

# Set the default command
CMD ["gunicorn", "--pythonpath", "/opt/render/project/src", "-w", "4", "-k", "uvicorn.workers.UvicornWorker", "--bind", "0.0.0.0:80", "service:app"]
